# Ethereum Client Makefile
# Provides convenient commands for testing and development

.PHONY: help test test-unit test-mock test-basic test-cli build clean lint fmt check install-deps setup-env

# Default target
help:
	@echo "ğŸ§ª Ethereum Client Development Commands"
	@echo "======================================"
	@echo ""
	@echo "Testing:"
	@echo "  make test       - Run all tests"
	@echo "  make test-unit  - Run unit tests only"
	@echo "  make test-mock  - Run mock integration tests"
	@echo "  make test-basic - Run basic usage test (requires config)"
	@echo "  make test-cli   - Test CLI commands"
	@echo ""
	@echo "Development:"
	@echo "  make build      - Build the project"
	@echo "  make check      - Check code without building"
	@echo "  make lint       - Run clippy lints"
	@echo "  make fmt        - Format code"
	@echo "  make clean      - Clean build artifacts"
	@echo ""
	@echo "Setup:"
	@echo "  make setup-env  - Copy .env.example to .env"
	@echo "  make install-deps - Install development dependencies"
	@echo ""
	@echo "Examples:"
	@echo "  make example-basic    - Run basic usage example"
	@echo "  make example-mock     - Run mock integration example"

# Testing commands
test:
	@echo "ğŸ§ª Running all tests..."
	./test_commands.sh all

test-unit:
	@echo "ğŸ”¬ Running unit tests..."
	cargo test

test-mock:
	@echo "ğŸ­ Running mock integration tests..."
	cargo run --example mock_integration

test-basic:
	@echo "ğŸ”§ Running basic usage test..."
	cargo run --example basic_usage

test-cli:
	@echo "ğŸ–¥ï¸  Testing CLI commands..."
	./test_commands.sh cli

# Build commands
build:
	@echo "ğŸ”¨ Building project..."
	cargo build

build-release:
	@echo "ğŸš€ Building release version..."
	cargo build --release

check:
	@echo "ğŸ” Checking code..."
	cargo check

# Code quality
lint:
	@echo "ğŸ“ Running clippy lints..."
	cargo clippy -- -D warnings

fmt:
	@echo "ğŸ¨ Formatting code..."
	cargo fmt

fmt-check:
	@echo "ğŸ“‹ Checking code formatting..."
	cargo fmt -- --check

# Cleanup
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cargo clean

# Setup commands
setup-env:
	@if [ ! -f .env ]; then \
		echo "ğŸ“ Creating .env file from template..."; \
		cp .env.example .env; \
		echo "âœ… .env file created. Please edit it with your configuration."; \
	else \
		echo "âš ï¸  .env file already exists."; \
	fi

install-deps:
	@echo "ğŸ“¦ Installing development dependencies..."
	@# Install cargo tools if not present
	@command -v cargo-watch >/dev/null 2>&1 || { echo "Installing cargo-watch..."; cargo install cargo-watch; }
	@command -v cargo-nextest >/dev/null 2>&1 || { echo "Installing cargo-nextest..."; cargo install cargo-nextest; }
	@echo "âœ… Development dependencies installed."

# Example commands
example-basic:
	@echo "ğŸ“– Running basic usage example..."
	cargo run --example basic_usage

example-mock:
	@echo "ğŸ“– Running mock integration example..."
	cargo run --example mock_integration

# CLI commands with common parameters
cli-help:
	@echo "ğŸ“š Showing CLI help..."
	cargo run --bin ethereum_service -- --help

cli-network-stats:
	@echo "ğŸ“Š Getting network statistics..."
	cargo run --bin ethereum_service network-stats

# Development workflow
dev: fmt lint check test-unit
	@echo "âœ… Development checks completed!"

# CI workflow
ci: fmt-check lint build test
	@echo "âœ… CI pipeline completed!"

# Watch commands (requires cargo-watch)
watch-test:
	@echo "ğŸ‘€ Watching for changes and running tests..."
	cargo watch -x test

watch-check:
	@echo "ğŸ‘€ Watching for changes and checking code..."
	cargo watch -x check

# Database setup (if using database features)
setup-db:
	@echo "ğŸ—„ï¸  Setting up database..."
	@if command -v docker >/dev/null 2>&1; then \
		docker run -d \
			--name ethereum-cache-test \
			-e POSTGRES_PASSWORD=password \
			-e POSTGRES_DB=ethereum_cache \
			-p 5433:5432 \
			postgres:15; \
		echo "âœ… Test database started on port 5433"; \
		echo "ğŸ’¡ Use: export DATABASE_URL=postgresql://postgres:password@localhost:5433/ethereum_cache"; \
	else \
		echo "âŒ Docker not found. Please install Docker to set up test database."; \
	fi

cleanup-db:
	@echo "ğŸ§¹ Cleaning up test database..."
	@docker stop ethereum-cache-test >/dev/null 2>&1 || true
	@docker rm ethereum-cache-test >/dev/null 2>&1 || true
	@echo "âœ… Test database cleaned up."